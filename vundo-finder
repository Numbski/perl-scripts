#!/usr/bin/env perl
 
use strict;
use POSIX;
use Filesys::SmbClient;
  
my $domain = 'gknstl.com';

my @hosts = qw(
    755beta
    adc-stl-01
    adc-stl-02
    adp-stl-01
    att-stl-01
    att-stl-01new
    att-tst-01
    avs-stl-01
    bas-stl-02
    bckup-stl-01
    bry-stl-01
    con-stl-01
    dnc-stl-fo
    dnc-stl-v1
    dve-stl-01
    dve-stl-02
    eng-stl-01
    eng-stl-02
    eng-stl-03
    eng-stl-04
    era-stl-01
    evault
    evaultca-stl-01
    fap-stl-v1
    fil-nae-01
    galappliance
    gal-appl-na
    hpm-stl-01
    it001007
    it003148
    it003483
    it003492
    it003550
    it003572
    it003594
    it003600
    it003603
    it003622
    it003735
    it005100v1
    it005100v2
    it005130
    it007012
    it007027
    it007093
    it007105
    it007128
    it007178
    it007183
    it007212
    it205146
    it205147
    itweb-stl-01
    lap004087
    lap004088
    lap004095
    lap004098
    lap004101
    lap004104
    lap004105
    lap004106
    lap004109
    lap004110
    lap004112
    lap004116
    lap004117
    lap004118
    lap004120
    lap004127
    lap004129
    lap004131
    lap004133
    lap004136
    lap004137
    lap004140
    lap004141
    lap004142
    lap004145
    lap004147
    lap004149
    lap004150
    lap004151
    lap004152
    lap004153
    lap004154
    lap004155
    lap004156
    lap004157
    lap004158
    lap004160
    lap004162
    lap004166
    lap004168
    lap004170
    lap004171
    lap004172
    lap004174
    lap004178
    lap004179
    lap004185
    lap004186
    lap004190
    lap004191
    lap004196
    lic-stl-01
    mad-stl-01
    mom-stl-01
    mps-stl-01
    nas-stl-v1
    ocs-stl-01
    pc003075
    pc003310
    pc003320
    pc003353
    pc003375
    pc003377
    pc003486
    pc003502
    pc003506
    pc003509
    pc003510
    pc003511
    pc003514
    pc003520
    pc003528
    pc003534
    pc003535
    pc003537
    pc003549
    pc003551
    pc003558
    pc003559
    pc003560
    pc003563
    pc003564
    pc003565
    pc003566
    pc003567
    pc003568
    pc003569
    pc003570
    pc003571
    pc003573
    pc003574
    pc003577
    pc003578
    pc003579
    pc003580
    pc003584
    pc003589
    pc003590
    pc003592
    pc003593
    pc003595
    pc003598
    pc003599
    pc003604
    pc003606
    pc003609
    pc003610
    pc003611
    pc003616
    pc003617
    pc003618
    pc003619
    pc003621
    pc003623
    pc003624
    pc003625
    pc003626
    pc003629
    pc003630
    pc003631
    pc003632
    pc003634
    pc003635
    pc003639
    pc003640
    pc003642
    pc003643
    pc003644
    pc003646
    pc003647
    pc003648
    pc003649
    pc003650
    pc003651
    pc003653
    pc003656
    pc003658
    pc003659
    pc003661
    pc003663
    pc003665
    pc003668
    pc003669
    pc003670
    pc003671
    pc003672
    pc003673
    pc003674
    pc003675
    pc003676
    pc003680
    pc003681
    pc003682
    pc003686
    pc003687
    pc003688
    pc003694
    pc003695
    pc003698
    pc003699
    pc003700
    pc003701
    pc003702
    pc003703
    pc003707
    pc003709
    pc003720
    pc003721
    pc003723
    pc003724
    pc003725
    pc003726
    pc003728
    pc003729
    pc003730
    pc003736
    pc003737
    pc003739
    pc003741
    pc003742
    pc003743
    pc003744
    pc003745
    pc003746
    pc003747
    pc003748
    pc003750
    pc003752
    pc003753
    pc003754
    pc003755
    pc003756
    pc003757
    pc003758
    pc003759
    pc003760
    pc003761
    pc003762
    pc003763
    pc003765
    pc003766
    pc003767
    pc003769
    pc003770
    pc003771
    pc003772
    pc003775
    pc003776
    pc003777
    pc003778
    pc003779
    pc003780
    pc003781
    pc003782
    pc003783
    pc003786
    pc003789
    pc003790
    pc003791
    pc003792
    pc003793
    pc003794
    pc003797
    pc003798
    pc003799
    pc003800
    pc003802
    pc003803
    pc003804
    pc003806
    pc003809
    pc003812
    pc003813
    pc003814
    pc003817
    pc003819
    pc003823
    pc003829
    pc003830
    pc003831
    pc003833
    pc003834
    pc003835
    pc003836
    pc003837
    pc003838
    pc003839
    pc003843
    pc003845
    pc003846
    pc003850
    pc003852
    pc003853
    pc003854
    pc003855
    pc003856
    pc003857
    pc003859
    pc003860
    pc003863
    pc003864
    pc003865
    pc003867
    pc003870
    pc003871
    pc003872
    pc003873
    pc003874
    pc003875
    pc003877
    pc003879
    pc003880
    pc003881
    pc003882
    pc003884
    pc003886
    pc003887
    pc003889
    pc003891
    pc003892
    pc003894
    pc003895
    pc003896
    pc003899
    pc003902
    pc003904
    pc003906
    pc003909
    pc003917
    pc003919
    pc003921
    pc003922
    pc003925
    pc003926
    pc003931
    pc003933
    pc003938
    pc003944
    pc003948
    pc007013
    pc007035
    pc007042
    pc007045
    pc007050
    pc007054
    pc007064
    pc007073
    pc007075
    pc007077
    pc007084
    pc007103
    pc007110
    pc007116
    pc007120
    pc007125
    pc007134
    pc007138
    pc007156
    pc007157
    pc007158
    pc007159
    pc007161
    pc007162
    pc007163
    pc007165
    pc007204
    pc007216
    pc007218
    pc007219
    pc007222
    pc007227
    pc007228
    pc007229
    pc007231
    pc007236
    pc007243
    pc007244
    pc007248
    pc007254
    pc007256
    pc007258
    pc007259
    pc007260
    pc007264
    physecwks
    pro-stl-01
    pro-stl-02
    pro-stl-03
    prt-stl-c1a
    prt-stl-c1b
    prt-stl-clu
    prt-stl-sql
    prt-stl-v1
    ras-stl-01
    ris-stl-01
    security
    shadwickt-vm
    sms-stl-01
    sqlstl02
    sql-stl-c1a
    sql-stl-c1b
    sql-stl-clu
    sql-stl-vs1
    sql-tst-01
    trm-stl-01
    tru-stl-01
    ugs-stl-01
    vma-stl-02
    vmjs
    vms-stl-01
    wchapp-stl-01
    wchora-stl-01
    wch-stl-02
    ws005082
    ws005083
    ws005092
    ws005095
    ws005096
    ws005102
    ws005104
    ws005105
    ws005107
    ws005108
    ws005110
    ws005111
    ws005112
    ws005113
    ws005115
    ws005116
    ws005117
    ws005118
    ws005119
    ws005120
    ws005122
    ws005124
    ws005127
    ws005133
    ws005135
    ws005136
    ws005137
    ws005138
    ws005139
    ws005140
    ws005142
    ws005143
    ws005144
    ws005147
    ws005148
    ws005149
    ws005159
    ws005161
    ws005163
    ws005171
    ws005175
    ws005178
    wsus-stl-01
    www-stl-05
    www-stl-06
    www-stl-tap
    www-tst-01
    xch-stl-01
    xch-stl-c1a
    xch-stl-c1b
    xch-stl-clu
);

my %infected;
my %errors;

print "Beginning check on ".scalar(@hosts)." hosts.\n";

HOST:
foreach my $host(sort @hosts){
	local *FD;
	tie(*FD, 'Filesys::SmbClient');
	my $smb = new Filesys::SmbClient(username  => '',
									password => '',
									workgroup => 'GKNSTL',
                                   debug     => 0);
	print "Working on $host\n";
	if(open(FD,'smb://'.$host.'/C$/windows/system32/drivers/etc/hosts')){
		print "$host: Windows Directory.\n";
	}
	elsif(open(FD,'smb://'.$host.'/C$/winnt/system32/drivers/etc/hosts')){
		print "$host: WINNT Directory\n";
	}
	else{
		print "$host: Can't open file:", $!, "\n";
		$errors{$host} = "Could not open hosts file: $!";
		next HOST;
	}
	while(<FD>) { 
		if(/brenz/i){
			print "$host is infected.\n";
			push(@{ $infected{$host} }, $1);		
		}
	}
	close(FD);

}

if(scalar(%errors)){
	print "The following hosts had errors:\n";
	foreach my $host(sort keys %errors){
		print "$host: $errors{$host}\n";
	}
}

if(scalar(%infected)){
	print "The following systems might have the Vundo variant:\n";
	foreach my $host(sort keys %infected){
		foreach my $line(@{$infected{$host}}){
			print "$host: $line\n";
		}
		print "\n";
	}
}

